stages:
  - build
  - test

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# =============================================================================
# Hidden job templates (prefixed with . so they don't run directly)
# =============================================================================

.linux-base:
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg lsb-release software-properties-common
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y cmake ninja-build llvm-17 llvm-17-dev libreadline-dev pkg-config build-essential
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config

.linux-test-base:
  image: ubuntu:22.04
  stage: test
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev clang-17 libreadline-dev build-essential
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
    - ln -sf /usr/bin/clang-17 /usr/bin/clang
    - ln -sf /usr/bin/clang++-17 /usr/bin/clang++

# =============================================================================
# Build jobs
# =============================================================================

build-linux-debug:
  extends: .linux-base
  stage: build
  script:
    - cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug
    - cmake --build build --parallel
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

build-linux-release:
  extends: .linux-base
  stage: build
  script:
    - cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
    - cmake --build build --parallel
  artifacts:
    paths:
      - build/
    expire_in: 1 week

# =============================================================================
# Test jobs - Debug build
# =============================================================================

test-types-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_types_tests.sh

test-cpp-types-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_cpp_type_tests.sh

test-list-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_list_tests.sh

test-autodiff-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_autodiff_tests.sh

test-memory-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_memory_tests.sh

test-modules-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_modules_tests.sh

test-stdlib-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_stdlib_tests.sh

test-features-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_features_tests.sh

test-ml-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_ml_tests.sh

test-neural-debug:
  extends: .linux-test-base
  needs: [build-linux-debug]
  script:
    - ./scripts/run_neural_tests.sh

# =============================================================================
# Test jobs - Release build
# =============================================================================

test-types-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_types_tests.sh

test-cpp-types-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_cpp_type_tests.sh

test-list-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_list_tests.sh

test-autodiff-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_autodiff_tests.sh

test-memory-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_memory_tests.sh

test-modules-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_modules_tests.sh

test-stdlib-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_stdlib_tests.sh

test-features-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_features_tests.sh

test-ml-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_ml_tests.sh

test-neural-release:
  extends: .linux-test-base
  needs: [build-linux-release]
  script:
    - ./scripts/run_neural_tests.sh
