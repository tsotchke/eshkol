stages:
  - build
  - test

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# Linux Debug Build
build-linux-debug:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg lsb-release software-properties-common
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y cmake ninja-build llvm-17 llvm-17-dev libreadline-dev pkg-config build-essential
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug
    - cmake --build build --parallel
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

# Linux Release Build
build-linux-release:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg lsb-release software-properties-common
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y cmake ninja-build llvm-17 llvm-17-dev libreadline-dev pkg-config build-essential
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
    - cmake --build build --parallel
  artifacts:
    paths:
      - build/
    expire_in: 1 week

# Test jobs - run after build
test-types-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_types_tests.sh

test-cpp-types-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_cpp_type_tests.sh

test-list-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_list_tests.sh

test-autodiff-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_autodiff_tests.sh

test-memory-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_memory_tests.sh

test-modules-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_modules_tests.sh

test-stdlib-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_stdlib_tests.sh

test-features-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_features_tests.sh

test-ml-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_ml_tests.sh

test-neural-debug:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-debug]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_neural_tests.sh

# Release build tests
test-types-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_types_tests.sh

test-cpp-types-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_cpp_type_tests.sh

test-list-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_list_tests.sh

test-autodiff-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_autodiff_tests.sh

test-memory-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_memory_tests.sh

test-modules-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_modules_tests.sh

test-stdlib-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_stdlib_tests.sh

test-features-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_features_tests.sh

test-ml-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_ml_tests.sh

test-neural-release:
  stage: test
  image: ubuntu:22.04
  needs: [build-linux-release]
  before_script:
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
    - echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main" | tee /etc/apt/sources.list.d/llvm.list
    - apt-get update
    - apt-get install -y llvm-17 llvm-17-dev libreadline-dev
    - ln -sf /usr/bin/llvm-config-17 /usr/bin/llvm-config
  script:
    - ./scripts/run_neural_tests.sh
