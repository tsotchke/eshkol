;;
;; HoTT Type System Tests - Type Introspection
;;
;; Tests the type-of function and type predicates
;;

(require stdlib)

;; ============================================================================
;; Type Constants (from eshkol_value_type_t in eshkol.h)
;; ============================================================================
;; ESHKOL_VALUE_NULL        = 0   ; Empty/null value
;; ESHKOL_VALUE_INT64       = 1   ; 64-bit signed integer
;; ESHKOL_VALUE_DOUBLE      = 2   ; Double-precision floating point
;; ESHKOL_VALUE_CONS_PTR    = 3   ; Pointer to cons cell (list)
;; ESHKOL_VALUE_DUAL_NUMBER = 4   ; Dual number for forward-mode AD
;; ESHKOL_VALUE_AD_NODE_PTR = 5   ; Pointer to AD computation graph node
;; ESHKOL_VALUE_TENSOR_PTR  = 6   ; Pointer to tensor structure
;; ESHKOL_VALUE_LAMBDA_SEXPR= 7   ; Lambda S-expression metadata
;; ESHKOL_VALUE_STRING_PTR  = 8   ; Pointer to string
;; ESHKOL_VALUE_CHAR        = 9   ; Character (Unicode codepoint)
;; ESHKOL_VALUE_VECTOR_PTR  = 10  ; Pointer to Scheme vector
;; ESHKOL_VALUE_SYMBOL      = 11  ; Symbol (interned string)
;; ESHKOL_VALUE_CLOSURE_PTR = 12  ; Pointer to closure
;; ESHKOL_VALUE_BOOL        = 13  ; Boolean (#t or #f)

;; Test framework
(define tests-passed 0)
(define tests-failed 0)

(define (check name expected actual)
  (if (equal? expected actual)
      (begin
        (set! tests-passed (+ tests-passed 1))
        (display name) (display ": PASS\n"))
      (begin
        (set! tests-failed (+ tests-failed 1))
        (display name) (display ": FAIL - expected ")
        (display expected) (display " got ") (display actual) (display "\n"))))

(define (check-true name actual)
  (if actual
      (begin
        (set! tests-passed (+ tests-passed 1))
        (display name) (display ": PASS\n"))
      (begin
        (set! tests-failed (+ tests-failed 1))
        (display name) (display ": FAIL - expected #t\n"))))

(define (check-false name actual)
  (if (not actual)
      (begin
        (set! tests-passed (+ tests-passed 1))
        (display name) (display ": PASS\n"))
      (begin
        (set! tests-failed (+ tests-failed 1))
        (display name) (display ": FAIL - expected #f\n"))))

;; ============================================================================
;; TESTS
;; ============================================================================

(display "╔══════════════════════════════════════════════════════════════════╗\n")
(display "║             HoTT TYPE INTROSPECTION TESTS                        ║\n")
(display "╚══════════════════════════════════════════════════════════════════╝\n\n")

(display "═══ Section 1: type-of function ═══\n")

(check "type-of integer" 1 (type-of 42))
(check "type-of float" 2 (type-of 3.14))
(check "type-of boolean" 13 (type-of #t))
(check "type-of list" 3 (type-of (list 1 2 3)))
(check "type-of string" 8 (type-of "hello"))
(check "type-of null" 0 (type-of '()))
(check "type-of vector" 10 (type-of (vector 1 2 3)))
(check "type-of char" 9 (type-of #\a))

;; Lambda/closure type
(define my-func (lambda (x) (+ x 1)))
(check "type-of lambda" 12 (type-of my-func))

(display "\n═══ Section 2: Type predicates ═══\n")

(check-true "integer? 42" (integer? 42))
(check-false "integer? 3.14" (integer? 3.14))
(check-true "real? 3.14" (real? 3.14))
(check-true "number? 42" (number? 42))
(check-true "number? 3.14" (number? 3.14))
(check-true "list? (list 1 2)" (list? (list 1 2)))
(check-true "string? hello" (string? "hello"))
(check-true "boolean? #t" (boolean? #t))
(check-true "boolean? #f" (boolean? #f))
(check-false "boolean? 42" (boolean? 42))
(check-true "procedure? lambda" (procedure? (lambda (x) x)))
(check-false "procedure? 42" (procedure? 42))

;; ============================================================================
;; SUMMARY
;; ============================================================================
(display "\n═══════════════════════════════════════════════════════════════\n")
(display "RESULTS: ")
(display tests-passed) (display " passed, ")
(display tests-failed) (display " failed\n")
(display "═══════════════════════════════════════════════════════════════\n")

(if (= tests-failed 0)
    (display "ALL TESTS PASSED!\n")
    (display "SOME TESTS FAILED!\n"))
