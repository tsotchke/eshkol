;;
;; HoTT Type System Tests - Type Introspection
;;
;; Tests the type-of function and type predicates
;;

(require stdlib)

;; ============================================================================
;; Type Constants (M1 Consolidated Pointer System)
;; ============================================================================
;; ESHKOL_VALUE_NULL      = 0   ; Empty/null value
;; ESHKOL_VALUE_INT64     = 1   ; 64-bit signed integer
;; ESHKOL_VALUE_DOUBLE    = 2   ; Double-precision floating point
;; ESHKOL_VALUE_BOOL      = 3   ; Boolean (#t or #f)
;; ESHKOL_VALUE_CHAR      = 4   ; Character (Unicode codepoint)
;; ESHKOL_VALUE_SYMBOL    = 5   ; Symbol (interned string)
;; ESHKOL_VALUE_DUAL      = 6   ; Dual number for forward-mode AD
;; ESHKOL_VALUE_UNDEFINED = 7   ; Undefined value
;; ESHKOL_VALUE_HEAP_PTR  = 8   ; Heap pointer (cons, string, vector, tensor, hash)
;; ESHKOL_VALUE_CALLABLE  = 9   ; Callable pointer (closure, lambda, ad-node)

;; Test framework
(define tests-passed 0)
(define tests-failed 0)

(define (check name expected actual)
  (if (equal? expected actual)
      (begin
        (set! tests-passed (+ tests-passed 1))
        (display name) (display ": PASS\n"))
      (begin
        (set! tests-failed (+ tests-failed 1))
        (display name) (display ": FAIL - expected ")
        (display expected) (display " got ") (display actual) (display "\n"))))

(define (check-true name actual)
  (if actual
      (begin
        (set! tests-passed (+ tests-passed 1))
        (display name) (display ": PASS\n"))
      (begin
        (set! tests-failed (+ tests-failed 1))
        (display name) (display ": FAIL - expected #t\n"))))

(define (check-false name actual)
  (if (not actual)
      (begin
        (set! tests-passed (+ tests-passed 1))
        (display name) (display ": PASS\n"))
      (begin
        (set! tests-failed (+ tests-failed 1))
        (display name) (display ": FAIL - expected #f\n"))))

;; ============================================================================
;; TESTS
;; ============================================================================

(display "╔══════════════════════════════════════════════════════════════════╗\n")
(display "║             HoTT TYPE INTROSPECTION TESTS                        ║\n")
(display "╚══════════════════════════════════════════════════════════════════╝\n\n")

(display "═══ Section 1: type-of function ═══\n")

(check "type-of integer" 1 (type-of 42))
(check "type-of float" 2 (type-of 3.14))
(check "type-of boolean" 3 (type-of #t))
(check "type-of list" 8 (type-of (list 1 2 3)))
(check "type-of string" 8 (type-of "hello"))
(check "type-of null" 0 (type-of '()))
(check "type-of vector" 8 (type-of (vector 1 2 3)))
(check "type-of char" 4 (type-of #\a))

;; Lambda/closure type (CALLABLE = 9)
(define my-func (lambda (x) (+ x 1)))
(check "type-of lambda" 9 (type-of my-func))

(display "\n═══ Section 2: Type predicates ═══\n")

(check-true "integer? 42" (integer? 42))
(check-false "integer? 3.14" (integer? 3.14))
(check-true "real? 3.14" (real? 3.14))
(check-true "number? 42" (number? 42))
(check-true "number? 3.14" (number? 3.14))
(check-true "list? (list 1 2)" (list? (list 1 2)))
(check-true "string? hello" (string? "hello"))
(check-true "boolean? #t" (boolean? #t))
(check-true "boolean? #f" (boolean? #f))
(check-false "boolean? 42" (boolean? 42))
(check-true "procedure? lambda" (procedure? (lambda (x) x)))
(check-false "procedure? 42" (procedure? 42))

;; ============================================================================
;; SUMMARY
;; ============================================================================
(display "\n═══════════════════════════════════════════════════════════════\n")
(display "RESULTS: ")
(display tests-passed) (display " passed, ")
(display tests-failed) (display " failed\n")
(display "═══════════════════════════════════════════════════════════════\n")

(if (= tests-failed 0)
    (display "ALL TESTS PASSED!\n")
    (display "SOME TESTS FAILED!\n"))
