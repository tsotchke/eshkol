;; Validation Suite 3: Backward Pass Accuracy
;; Tests that gradient propagation through backprop is mathematically correct

(define (test-simple-quadratic)
  (display "Test 3.1: Gradient of x² at x=5")
  (newline)
  (define f (lambda (v) (* (vref v 0) (vref v 0))))
  (define grad (gradient f (vector 5.0)))
  (display "Result: ")
  (display grad)
  (newline)
  (display "Expected: vector(10.0) - derivative 2x = 10")
  (newline)
  grad)

(define (test-linear-function)
  (display "Test 3.2: Gradient of 2x at x=3")
  (newline)
  (define f (lambda (v) (* 2.0 (vref v 0))))
  (define grad (gradient f (vector 3.0)))
  (display "Result: ")
  (display grad)
  (newline)
  (display "Expected: vector(2.0) - constant derivative")
  (newline)
  grad)

(define (test-multi-input-interaction)
  (display "Test 3.3: Gradient of x²+xy+y² at (3,4)")
  (newline)
  (define f (lambda (v)
    (+ (+ (* (vref v 0) (vref v 0))
          (* (vref v 0) (vref v 1)))
       (* (vref v 1) (vref v 1)))))
  (define grad (gradient f (vector 3.0 4.0)))
  (display "Result: ")
  (display grad)
  (newline)
  (display "Expected: vector(10.0, 11.0) - [2x+y, x+2y]")
  (newline)
  grad)

(define (test-chain-rule)
  (display "Test 3.4: Chain rule - gradient of (x+y)²")
  (newline)
  (define f (lambda (v)
    (let ((sum (+ (vref v 0) (vref v 1))))
      (* sum sum))))
  (define grad (gradient f (vector 2.0 3.0)))
  (display "Result: ")
  (display grad)
  (newline)
  (display "Expected: vector(10.0, 10.0) - both 2(x+y) = 10")
  (newline)
  grad)

(define (main)
  (display "===============================================")
  (newline)
  (display "VALIDATION SUITE 3: Backward Pass")
  (newline)
  (display "===============================================")
  (newline)
  (newline)
  
  (test-simple-quadratic)
  (newline)
  (test-linear-function)
  (newline)
  (test-multi-input-interaction)
  (newline)
  (test-chain-rule)
  
  (newline)
  (display "===============================================")
  (newline)
  (display "Backward Pass Tests Complete")
  (newline)
  (display "===============================================")
  (newline)
  
  0)